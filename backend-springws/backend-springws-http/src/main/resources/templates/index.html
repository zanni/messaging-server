<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="//cdn.jsdelivr.net/sockjs/1.0.3/sockjs.min.js"></script>
<style>
.box {
	width: 600px;
	float: left;
	margin: 0 20px 0 20px;
}

.box div, .box input {
	border: 1px solid;
	-moz-border-radius: 4px;
	border-radius: 4px;
	width: 100%;
	padding: 5px;
	margin: 3px 0 10px 0;
}

.box div {
	border-color: grey;
	height: 300px;
	overflow: auto;
}

div code {
	display: block;
}

#first div code {
	-moz-border-radius: 2px;
	border-radius: 2px;
	border: 1px solid #eee;
	margin-bottom: 5px;
}

#second div {
	font-size: 0.8em;
}
</style>
<title>Messaging Server</title>
</head>
<body lang="en">


 <h1>Generated by: {{server_name}}</h1>
 <div id="first" class="box">
  <h2>Received</h2>
  <div></div>
  <form>
   <input id="toUserId" autocomplete="off" placeholder="Recipient..."></input> <input id="content" autocomplete="off" placeholder="Message body..."></input>
   <button id="submit">Send</button>
  </form>
 </div>

 <div id="second" class="box">
  <h2>Logs</h2>
  <div></div>

  <button id="connect">Connect</button>
  <button id="reconnect">Reconnect</button>
  <button id="disconnect">Disconnect</button>
  <button id="clean">Clean</button>
  <p id="connected"></p>

 </div>
<script>
/*
 * setup connection:
 * - create session in java backend
 * - open STOMP connection using session's data
 * - subscribe to queue
 */
function setupConnection(userId) {
	
	var date = function(){
		pad = function (str, len) {
		    return (new Array(len+1).join("0") + str).slice(-len);
		}
		var today = new Date();

		var h = pad(today.getHours(), 2);
		var m = pad(today.getMinutes(), 2);
		var s = pad(today.getSeconds(), 2);
		return h+":"+m+":"+s
		
	}
	var debug = function(msg) {
		msg = date() + " " +msg;
		$('#second div').append($("<code>").text(msg));
	}

	var log = function(msg) {
		msg = date() + " " +msg;
		$('#second div').append($("<code>").text(msg).css("color", "green"));
	}

	var error = function(msg) {
		msg = date() + " " +msg;
		$('#second div').append($("<code>").text(msg).css("color", "red"));
	}

	var received = function(msg) {
		msg = date() + " " +msg;
		$('#first div').append($("<code>").text(msg));
	}
	
	var clean = function(){
		$('#first div').empty();
		$('#second div').empty();
	}

	// create session
	$.post(
			'/connect',
			{
				userId : userId
			},
			function(data) {

				var user = data.userId;
				var pass = data.listeningKey;

				// construct connection obj
				if (data.listeningAddress.indexOf("ws://") !== -1) {
					var client = new WebSocket(data.listeningAddress + "?token="
							+ pass + "&userId=" + user);
				} else if (data.listeningAddress.indexOf("http://") !== -1) {
					var client = new SockJS(data.listeningAddress + "?token="
							+ pass + "&userId=" + user);
				}

				// bind 'connect' button
				$("#connect").off("click");
				$("#connect").on("click", function(e) {
					e.preventDefault();
					client.onclose = null;
					client.close();
					userId = prompt("Please enter your userId");
					if (userId) {
						setTimeout(function() {
							setupConnection(userId);
						}, 500);
					}

				});
				
				// bind 'reconnect' button
				$("#reconnect").off("click");
				$("#reconnect").on("click", function(e) {
					e.preventDefault();
					client.onclose = null;
					client.close();
					setTimeout(function() {
						setupConnection(userId);
					}, 500);
				});

				// bind 'disconnect' button
				$("#disconnect").off("click");
				$("#disconnect").on("click", function(e) {
					e.preventDefault();
					$('#connected').text("Not connected");
					client.onclose = null;
					client.close();
					debug("Disconnected");
				});

				$('#connected').text(
						"Connected as user: " + userId + " on server: "
								+ data.listeningAddress);

				client.onopen = function() {
					debug("Connected as user: " + userId + " on server: "
								+ data.listeningAddress);
				}
				client.onmessage = function(e) {
					received(e.data);
				};
				client.onclose = function() {
					log("Server deconnect, trying to reconnect...");
// 					setTimeout(function() {
// 						setupConnection(userId);
// 					}, 500);
				};

				$("#submit").off("click");
				$("#submit").on("click", function(e) {
					e.preventDefault();
					var toUserId = $("#toUserId").val();
					var content = $("#content").val();
					client.send(JSON.stringify({
						from : userId,
						to : toUserId,
						content : content
					}));
				});

			}).fail(function(e) {
				var exp = JSON.parse(e.responseText);
				console.log('error', exp);
				error(exp.message)
				$('#connected').text("Not connected");
				// bind 'connect' button
				$("#connect").off("click");
				$("#connect").on("click", function(e) {
					e.preventDefault();
					userId = prompt("Please enter your userId");
					if (userId) {
						setupConnection(userId);
					}
				});
				// bind 'reconnect' button
				$("#reconnect").off("click");
				$("#reconnect").on("click", function(e) {
					e.preventDefault();
					setTimeout(function() {
						setupConnection(userId);
					}, 500);
				});

	});
}

var userId = prompt("Please enter your userId");
if (userId) {
	setupConnection(userId);
}

$("#clean").click(function() {
	$('#first div').empty();
	$('#second div').empty();
});

</script>


</body>
</html>