<!DOCTYPE html>
<html>
<head>
<script
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script src="//cdn.jsdelivr.net/sockjs/1.0.3/sockjs.min.js"></script>
<script src="stomp.js"></script>
<style>
.box {
	width: 440px;
	float: left;
	margin: 0 20px 0 20px;
}

.box div, .box input {
	border: 1px solid;
	-moz-border-radius: 4px;
	border-radius: 4px;
	width: 100%;
	padding: 5px;
	margin: 3px 0 10px 0;
}

.box div {
	border-color: grey;
	height: 300px;
	overflow: auto;
}

div code {
	display: block;
}

#first div code {
	-moz-border-radius: 2px;
	border-radius: 2px;
	border: 1px solid #eee;
	margin-bottom: 5px;
}

#second div {
	font-size: 0.8em;
}
</style>
<title>RabbitMQ Web STOMP Examples : Temporary Queue</title>
<link href="main.css" rel="stylesheet" type="text/css" />
</head>
<body lang="en">
	<h1>Messaging Server</h1>

	<p id="connected"></p>

	<div id="first" class="box">
		<h2>Received</h2>
		<div></div>
		<form>
			<input id="toUserId" autocomplete="off" placeholder="Recipient..."></input>
			<input id="content" autocomplete="off" placeholder="Message body..."></input>
			<button id="submit">Send</button>
		</form>
	</div>

	<div id="second" class="box">
		<h2>Logs</h2>
		<div></div>
	</div>


	<script>
		var userId = prompt("Please enter your userId");

		var host = "192.168.10.74";
		var user = "anonymous";
		var pass = "anonymous";

		$
				.post(
						'/connect',
						{
							userId : userId
						},
						function(data) {

							$('#connected')
									.text("Connected as user: " + userId);

							if (data.listeningAddress.indexOf("ws://") !== -1) {
								var ws = new WebSocket(data.listeningAddress);
							} else if (data.listeningAddress.indexOf("http://") !== -1) {
								var ws = new SockJS(data.listeningAddress);
							}
							var client = Stomp.over(ws);

							client.debug = function(e) {
								$('#second div').append($("<code>").text(e));
							};

							var on_connect_closure = function(topic) {
								return function(x) {
									id = client.subscribe("/queue/"
											+ topic.listeningKey, function(m) {
										console.log(m);
										$('#first div').append(
												$("<code>").text(m.body));
									}, {'auto-delete' : true, 'durable' : false, 'exclusive':true});
								};s
							}
							var on_error = function(e) {
								console.log('error', e);
								$('#second div').append($("<code>").text(e));
							};
							client.connect(user, pass,
									on_connect_closure(data), on_error, '/'
									);

							$("#submit").click(function(e) {
								e.preventDefault();
								var toUserId = $("#toUserId").val();
								var content = $("#content").val();
								$.post('/exchange', {
									fromUserId : userId,
									toUserId : toUserId,
									content : content
								}, function(data) {
									console.log(data);
								});
							});

						}).fail(function(e) {
					var exp = JSON.parse(e.responseText);
					console.log('error', exp);
					$('#second div').append($("<code>").text(exp.message));
				});

		/* $('#first form').submit(function() {
			var text = $('#first form input').val();
			if (text) {
				client.send('/queue/test', {
					'reply-to' : '/temp-queue/foo'
				}, text);
				$('#first form input').val("");
			}
			return false;
		}); */
	</script>
</body>
</html>